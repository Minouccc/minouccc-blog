---
title: ğŸš€ è·¯ç”±ç¯‡ App Router
date: '2024-06-15'
tags: ['nextjs']
draft: false
summary: æœ¬æ–‡å°†å…¨é¢è®²è§£ Next.js åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±è§£å†³æ–¹æ¡ˆ App Routerï¼Œä»‹ç»äº†ç”¨äºå®šä¹‰é¡µé¢çš„page.jsã€å®šä¹‰å¸ƒå±€çš„layout.jsã€å®šä¹‰æ¨¡æ¿çš„template.jsã€å®šä¹‰åŠ è½½ç•Œé¢çš„loading.jsã€å®šä¹‰é”™è¯¯å¤„ç†çš„error.jsã€å®šä¹‰ 404 é¡µé¢çš„not-found.jsã€‚
---

## å‰è¨€

è·¯ç”±ï¼ˆRouterï¼‰æ˜¯ Next.js åº”ç”¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚åœ¨ Next.js ä¸­ï¼Œè·¯ç”±å†³å®šäº†ä¸€ä¸ªé¡µé¢å¦‚ä½•æ¸²æŸ“æˆ–è€…ä¸€ä¸ªè¯·æ±‚è¯¥å¦‚ä½•è¿”å›ã€‚

Next.js æœ‰ä¸¤å¥—è·¯ç”±è§£å†³æ–¹æ¡ˆï¼Œä¹‹å‰çš„æ–¹æ¡ˆç§°ä¹‹ä¸ºâ€œPages Routerâ€ï¼Œç›®å‰çš„æ–¹æ¡ˆç§°ä¹‹ä¸ºâ€œApp Routerâ€ï¼Œä¸¤å¥—æ–¹æ¡ˆç›®å‰æ˜¯å…¼å®¹çš„ï¼Œéƒ½å¯ä»¥åœ¨ Next.js ä¸­ä½¿ç”¨ã€‚

ä» v13.4 èµ·ï¼ŒApp Router å·²æˆä¸ºé»˜è®¤çš„è·¯ç”±æ–¹æ¡ˆï¼Œæ–°çš„ Next.js é¡¹ç›®å»ºè®®ä½¿ç”¨ App Routerã€‚

## 1. Next.js ä¸ºä»€ä¹ˆå‡çº§åˆ° App Router ï¼Ÿ

- Pages Router æ–¹å¼æœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œé‚£å°±æ˜¯ pages ç›®å½•çš„æ‰€æœ‰ js æ–‡ä»¶éƒ½ä¼šè¢«å½“æˆè·¯ç”±æ–‡ä»¶ï¼Œè¿™å°±å¯¼è‡´æ¯”å¦‚ç»„ä»¶ä¸èƒ½å†™åœ¨ pages ç›®å½•ä¸‹ï¼Œä¸ç¬¦åˆå¼€å‘è€…çš„ä½¿ç”¨ä¹ æƒ¯ã€‚ï¼ˆå½“ç„¶ Pages Router è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„é—®é¢˜ï¼‰
- å‡çº§ä¸ºæ–°çš„ App Router åï¼Œç°åœ¨çš„ç›®å½•ç»“æ„ç±»ä¼¼äºï¼š

```javascript
src/
â””â”€â”€ app
    â”œâ”€â”€ page.js
    â”œâ”€â”€ layout.js
    â”œâ”€â”€ template.js
    â”œâ”€â”€ loading.js
    â”œâ”€â”€ error.js
    â””â”€â”€ not-found.js
    â”œâ”€â”€ about
    â”‚   â””â”€â”€ page.js
    â””â”€â”€ more
        â””â”€â”€ page.js
```

å±‚çº§å…³ç³»:

![image.pngs](http://blog.minouccc.online:9000/blog/app_router_1.png)

## 3. ä½¿ç”¨ App Router

### 3.1 å®šä¹‰è·¯ç”±ï¼ˆRoutesï¼‰

åˆ›å»ºåµŒå¥—çš„è·¯ç”±ï¼Œåªéœ€è¦åˆ›å»ºåµŒå¥—çš„æ–‡ä»¶å¤¹ã€‚ä¾‹å¦‚ï¼Œ`app/dashboard/settings` ç›®å½•å¯¹åº”çš„è·¯ç”±åœ°å€å°±æ˜¯ `/dashboard/settings`ã€‚

### 3.2 å®šä¹‰é¡µé¢ï¼ˆPagesï¼‰

éœ€è¦åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„åä¸º `page.js` çš„æ–‡ä»¶ã€‚

### 3.3 å®šä¹‰å¸ƒå±€ï¼ˆLayoutsï¼‰

å®šä¹‰ä¸€ä¸ªå¸ƒå±€ï¼Œä½ éœ€è¦æ–°å»ºä¸€ä¸ªåä¸º `layout.js` çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶é»˜è®¤å¯¼å‡ºä¸€ä¸ª React ç»„ä»¶ï¼Œè¯¥ç»„ä»¶åº”æ¥æ”¶ä¸€ä¸ª `children` propï¼Œè¡¨ç¤ºå­å¸ƒå±€æˆ–å­é¡µé¢ã€‚

- æ³¨æ„ï¼šå¸ƒå±€æ˜¯æ”¯æŒ**åµŒå¥—**çš„

#### æ ¹å¸ƒå±€ï¼ˆRoot Layoutï¼‰

å¸ƒå±€æ”¯æŒåµŒå¥—ï¼Œæœ€é¡¶å±‚çš„å¸ƒå±€æˆ‘ä»¬ç§°ä¹‹ä¸ºæ ¹å¸ƒå±€ï¼ˆRoot Layoutï¼‰ï¼Œä¹Ÿå°±æ˜¯ `app/layout.js`ã€‚å®ƒä¼šåº”ç”¨äºæ‰€æœ‰çš„è·¯ç”±ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ªå¸ƒå±€è¿˜æœ‰ç‚¹ç‰¹æ®Šã€‚

ä½¿ç”¨ `create-next-app` é»˜è®¤åˆ›å»ºçš„ `layout.js` ä»£ç å¦‚ä¸‹ï¼š

```javascript
// app/layout.js
import './globals.css'
import { Inter } from 'next/font/google'

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  )
}
```

å…¶ä¸­ï¼š

1.  `app` ç›®å½•å¿…é¡»åŒ…å«æ ¹å¸ƒå±€ï¼Œä¹Ÿå°±æ˜¯ `app/layout.js` è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…éœ€çš„ã€‚
2.  æ ¹å¸ƒå±€å¿…é¡»åŒ…å« `html` å’Œ `body`æ ‡ç­¾ï¼Œå…¶ä»–å¸ƒå±€ä¸èƒ½åŒ…å«è¿™äº›æ ‡ç­¾ã€‚å¦‚æœä½ è¦æ›´æ”¹è¿™äº›æ ‡ç­¾ï¼Œä¸æ¨èç›´æ¥ä¿®æ”¹ï¼Œå‚è€ƒ[ã€ŠMetadata ç¯‡ã€‹](xxx)ã€‚
3.  ä½ å¯ä»¥ä½¿ç”¨[è·¯ç”±ç»„](xxx)åˆ›å»ºå¤šä¸ªæ ¹å¸ƒå±€ã€‚
4.  é»˜è®¤æ ¹å¸ƒå±€æ˜¯[æœåŠ¡ç«¯ç»„ä»¶](xxx)ï¼Œä¸”ä¸èƒ½è®¾ç½®ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ã€‚

### 3.4 å®šä¹‰æ¨¡æ¿ï¼ˆTemplatesï¼‰

æ¨¡æ¿ç±»ä¼¼äºå¸ƒå±€ï¼Œå®ƒä¹Ÿä¼šä¼ å…¥æ¯ä¸ªå­å¸ƒå±€æˆ–é¡µé¢ï¼Œä½†ä¸ä¼šåƒå¸ƒå±€é‚£æ ·ç»´æŒçŠ¶æ€ã€‚

æŸäº›æƒ…å†µä¸‹ï¼Œæ¨¡æ¿ä¼šæ¯”å¸ƒå±€æ›´é€‚åˆï¼š

- ä¾èµ–äº `useEffect` å’Œ `useState` çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è®°å½•é¡µé¢è®¿é—®æ•°ï¼ˆç»´æŒçŠ¶æ€å°±ä¸ä¼šåœ¨è·¯ç”±åˆ‡æ¢æ—¶è®°å½•è®¿é—®æ•°äº†ï¼‰ã€ç”¨æˆ·åé¦ˆè¡¨å•ï¼ˆæ¯æ¬¡é‡æ–°å¡«å†™ï¼‰ç­‰ã€‚
- æ›´æ”¹æ¡†æ¶çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œå¸ƒå±€å†…çš„ `Suspense` åªä¼šåœ¨å¸ƒå±€åŠ è½½æ—¶å±•ç¤ºä¸€æ¬¡ fallback UIï¼Œä½†ä½¿ç”¨æ¨¡æ¿æ—¶ï¼Œfallback ä¼šåœ¨æ¯æ¬¡è·¯ç”±åˆ‡æ¢æ—¶å±•ç¤ºã€‚

### 3.5 å®šä¹‰åŠ è½½ç•Œé¢ï¼ˆLoading UIï¼‰

`loading.js` çš„å®ç°åŸç†æ˜¯å°† `page.js` å’Œä¸‹é¢çš„ `children` ç”¨ `<Suspense>` åŒ…è£¹ã€‚å› ä¸º `page.js` å¯¼å‡ºä¸€ä¸ª async å‡½æ•°ï¼Œ`Suspense` å¾—ä»¥æ•è·æ•°æ®åŠ è½½çš„ promiseï¼Œä»è€Œå®ç°äº† loading ç»„ä»¶çš„å…³é—­ã€‚

`dashboard` ç›®å½•ä¸‹æˆ‘ä»¬æ–°å»ºä¸€ä¸ª `loading.js`ã€‚
`loading.js`çš„ä»£ç å¦‚ä¸‹ï¼š

```javascript
// app/dashboard/loading.js
export default function DashboardLoading() {
  return <>Loading dashboard...</>
}
```

åŒçº§çš„ `page.js` ä»£ç å¦‚ä¸‹ï¼š

```javascript
// app/dashboard/page.js
async function getData() {
  await new Promise((resolve) => setTimeout(resolve, 3000))
  return {
    message: 'Hello, Dashboard!',
  }
}
export default async function DashboardPage(props) {
  const { message } = await getData()
  return <h1>{message}</h1>
}
```

ä¸å†éœ€è¦å…¶ä»–çš„ä»£ç ï¼Œloading çš„æ•ˆæœå°±å®ç°äº†ã€‚å…¶å…³é”®åœ¨äº page.jså¯¼å‡ºäº†ä¸€ä¸ª async å‡½æ•°ã€‚

å½“ç„¶å®ç° loading æ•ˆæœï¼Œä¸ä¸€å®šéå¯¼å‡ºä¸€ä¸ª async å‡½æ•°ã€‚ä¹Ÿå¯ä»¥å€ŸåŠ© React çš„ `use` å‡½æ•°ã€‚ç°åœ¨æˆ‘ä»¬åœ¨ `dashboard`ä¸‹æ–°å»ºä¸€ä¸ª `about`ç›®å½•ï¼Œåœ¨å…¶ä¸­æ–°å»º `page.js`æ–‡ä»¶ã€‚

`/dashboard/about/page.js` ä»£ç å¦‚ä¸‹ï¼š

```javascript
// /dashboard/about/page.js
import { use } from 'react'

async function getData() {
  await new Promise((resolve) => setTimeout(resolve, 5000))
  return {
    message: 'Hello, About!',
  }
}

export default function Page() {
  const { message } = use(getData())
  return <h1>{message}</h1>
}
```

åŒæ ·å®ç°äº† loading æ•ˆæœã€‚

### 3.6 å®šä¹‰é”™è¯¯å¤„ç†ï¼ˆError Handlingï¼‰

å…¶å®ç°å€ŸåŠ©äº† React çš„ Error Boundary åŠŸèƒ½ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç»™ `page.js` å’Œ `children` åŒ…äº†ä¸€å±‚ `ErrorBoundary`ã€‚

- **æ³¨æ„**ï¼š
  å› ä¸º Layout å’Œ Template åœ¨ ErrorBoundary å¤–é¢ï¼Œè¿™è¯´æ˜é”™è¯¯è¾¹ç•Œä¸èƒ½æ•è·åŒçº§çš„ `layout.js` æˆ– `template.js` ä¸­çš„é”™è¯¯ã€‚å¦‚æœä½ æƒ³æ•è·ç‰¹å®šå¸ƒå±€æˆ–æ¨¡æ¿ä¸­çš„é”™è¯¯ï¼Œé‚£å°±éœ€è¦åœ¨çˆ¶çº§çš„ `error.js` é‡Œè¿›è¡Œæ•è·ã€‚
  å¦‚æœå·²ç»åˆ°äº†é¡¶å±‚ï¼Œæ¯”å¦‚æ ¹å¸ƒå±€ä¸­çš„é”™è¯¯å¦‚ä½•æ•è·å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒNext.js æä¾›äº† `global-error.js` æ–‡ä»¶ï¼Œä½¿ç”¨æ—¶éœ€è¦å°†å…¶æ”¾åœ¨ `app` ç›®å½•ä¸‹ã€‚

`global-error.js`ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```javascript
'use client'
// app/global-error.js
export default function GlobalError({ error, reset }) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  )
}
```

æ³¨ï¼š`global-error.js` ç”¨æ¥å¤„ç†æ ¹å¸ƒå±€å’Œæ ¹æ¨¡æ¿ä¸­çš„é”™è¯¯ï¼Œ`app/error.js` å»ºè®®è¿˜æ˜¯è¦å†™çš„

### 3.7 å®šä¹‰ 404 é¡µé¢

`not-found.js` - å½“è¯¥è·¯ç”±ä¸å­˜åœ¨çš„æ—¶å€™å±•ç¤ºçš„å†…å®¹ã€‚

å…³äº `app/not-found.js` ä¸€å®šè¦è¯´æ˜ä¸€ç‚¹çš„æ˜¯ï¼Œå®ƒåªèƒ½ç”±ä¸¤ç§æƒ…å†µè§¦å‘ï¼š

1.  å½“ç»„ä»¶æŠ›å‡ºäº† notFound å‡½æ•°çš„æ—¶å€™
1.  å½“è·¯ç”±åœ°å€ä¸åŒ¹é…çš„æ—¶å€™

æ‰€ä»¥ `app/not-found.js` å¯ä»¥ä¿®æ”¹é»˜è®¤ 404 é¡µé¢çš„æ ·å¼ã€‚ä½†æ˜¯ï¼Œå¦‚æœ `not-found.js`æ”¾åˆ°äº†ä»»ä½•å­æ–‡ä»¶å¤¹ä¸‹ï¼Œå®ƒåªèƒ½ç”± `notFound`å‡½æ•°æ‰‹åŠ¨è§¦å‘ã€‚æ¯”å¦‚è¿™æ ·ï¼š

```javascript
// /dashboard/blog/page.js
import { notFound } from 'next/navigation'

export default function Page() {
  notFound()
  return <></>
}
```

æ‰§è¡Œ notFound å‡½æ•°æ—¶ï¼Œä¼šç”±æœ€è¿‘çš„ not-found.js æ¥å¤„ç†ã€‚ä½†å¦‚æœç›´æ¥è®¿é—®ä¸å­˜åœ¨çš„è·¯ç”±ï¼Œåˆ™éƒ½æ˜¯ç”± `app/not-found.js` æ¥å¤„ç†ã€‚

å¯¹åº”åˆ°å®é™…å¼€å‘ï¼Œå½“æˆ‘ä»¬è¯·æ±‚ä¸€ä¸ªç”¨æˆ·çš„æ•°æ®æ—¶æˆ–æ˜¯è¯·æ±‚ä¸€ç¯‡æ–‡ç« çš„æ•°æ®æ—¶ï¼Œå¦‚æœè¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œå°±å¯ä»¥ç›´æ¥ä¸¢å‡º `notFound` å‡½æ•°ï¼Œæ¸²æŸ“è‡ªå®šä¹‰çš„ `not-found.js` ç•Œé¢ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```javascript
// app/dashboard/blog/[id]/page.js
import { notFound } from 'next/navigation'

async function fetchUser(id) {
  const res = await fetch('https://...')
  if (!res.ok) return undefined
  return res.json()
}

export default async function Profile({ params }) {
  const user = await fetchUser(params.id)

  if (!user) {
    notFound()
  }

  // ...
}
```

## å‚è€ƒé“¾æ¥

1.  [Routers - MDN Web Docs Glossary: Definitions of Web-related terms | MDN](https://developer.mozilla.org/en-US/docs/Glossary/Routers)
2.  [Building Your Application: Routing](https://nextjs.org/docs/app/building-your-application/routing)
3.  [Routing: Defining Routes](https://nextjs.org/docs/app/building-your-application/routing/defining-routes)
4.  [Routing: Pages and Layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts)
5.  [Routing: Loading UI and Streaming](https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming)
6.  [Routing: Error Handling](https://nextjs.org/docs/app/building-your-application/routing/error-handling)
7.  [File Conventions: not-found.js](https://nextjs.org/docs/app/api-reference/file-conventions/not-found)
8.  [Functions: notFound](https://nextjs.org/docs/app/api-reference/functions/not-found)
