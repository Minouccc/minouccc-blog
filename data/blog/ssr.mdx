---
title: 🚀 SSR
date: '2024-07-03'
tags: ['ssr']
draft: false
summary: ssr 基本概念。
---

## CSR

在聊 ssr 之前，我们先来聊一下CSR，即客户端渲染（Client-Side Rendering，是一种在客户端（即浏览器）完成网页内容生成和渲染的技术，也就是浏览器端完成渲染。这个过程需要等待浏览器加载、解析和执行 JS 代码才能生成页面内容，首屏可能会有延迟。

一般情况下，CSR 项目都可以直接通过 vue 或者 react 脚手架进行创建，这里我们使用 react 创建一个 csr 应用，vue 也是一样的道理，然后运行后去网络中看一下文件加载的内容。

打开网络 -- 打开第一个网络地址 -- 点击查看响应内容

![1.png](http://blog.minouccc.online:9000/blog/ssr_1.1.png)

可以看到，在响应中，我们只看到了一个空的 div，如果你的网站也是这样，那就是 CSR 渲染的方式了。

在 CSR 渲染中，为什么说不利于首屏优化呢？在上面的那张截图中我们看到，script 的加载方式是 defer，也就是说 script 脚本和 html 是同时加载的，在解析到 script 脚本时并不会立即执行，而是在 html 加载完毕之后，再执行脚本内容，那也有可能先加载好 html，script 需要等待一会再解析完毕，这可能会导致白屏现象，而在 react 中我们可以使用 lazy 和 Suspense 来实现一下，这两个的功能就是当页面还没有加载完毕时，会显示 loading 的内容。

## SSR

前面我们说了 CSR，我们对 CSR 有了基本的了解之后，对 ssr 理解起来也会更容易一些。

### 什么是SSR？

SSR，即服务端渲染，是指在服务器端生成 HTML 内容并将其发送到客户端。这样一来，用户在首次访问页面时，浏览器可以直接展示完整的HTML内容，而无需等待 JS 在客户端完成渲染。

还是跟上面的一样，我们来看一下网站的响应的内容，这里我们拿掘金进行举例。

![2.png](http://blog.minouccc.online:9000/blog/ssr_1.2.png)

很明显，我们看到，掘金并不是和上面的 CSR 网站一样，直接返回一个空的 div，而是返回了很多的 html 内容，掘金的这个网站是采用 nuxt 实现的 ssr 渲染，nuxt 是基于 vue 实现的 ssr 框架，而react 对应的 next。

那掘金的div内的内容都是什么呢？

往下看，我们发现是首页一些 nav，以及侧边栏的信息，这些直接通过ssr服务端进行渲染出来的

![3.png](http://blog.minouccc.online:9000/blog/ssr_1.3.png)

同样的，我们也是刷新一下掘金网站再次验证一下，可以看到刷新网站并且3G情况下，掘金也不会出现白屏现象，nav 和侧边栏都是有数据的，而中间的内容是动态获取的，也就是说掘金的首页采取的是 SSR+CSR 混合模式，静态展示的内容采用 SSR，动态获取的内容采用CSR。

![4.gif](http://blog.minouccc.online:9000/blog/ssr_1.4.gif)

而静态展示的内容也是从服务端获取的，因为是不经常变化的，所以加了缓存浏览器的缓存策略，在一段时间内没有过期的话直接从本地获取，第一次会从服务端获取，后端则会直接从缓存中获取，可以通过Ttag字段看到。

![5.png](http://blog.minouccc.online:9000/blog/ssr_1.5.png)

在请求时携带上次服务端返回的etag，服务端经过比对如果没有静态资源没有发生变化，则不会重复请求，直接进行服用即可。

![6.png](http://blog.minouccc.online:9000/blog/ssr_1.6.png)

## 同构

事件相关的绑定是没办法在服务器端中进行的，那我们怎么才能把事件绑定到静态页面呢？

![7.png](http://blog.minouccc.online:9000/blog/ssr_1.7.png)

可以看到，掘金服务端返回的 HTML 文本中包括一组打包过后的 JS，这个其实就是这个页面所对应的相关事件和脚本，我们只需要打包过后将 JS 绑定在 HTML 中就可以。

**这个也叫“同构”，是服务器端渲染的核心概念**，同一套 React 代码在服务器端渲染一遍，然后在客户端再执行一遍。服务端负责静态 dom 的拼接，而客户端负责事件的绑定，不仅是模板页面渲染，后面的路由，数据的请求都涉及到同构的概念。

## 注水和脱水

对数据的网络请求，是通过同构 store 服务器拿到需要请求的函数通过路由把参数透传出去。对客户端页面脱水，移除数据层部分；服务器请求拿到store，注水，使得数据同步。
