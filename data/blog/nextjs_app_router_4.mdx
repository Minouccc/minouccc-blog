---
title: ğŸš€ è·¯ç”±ç¯‡ è·¯ç”±å¤„ç†ç¨‹åº
date: '2024-06-20'
tags: ['nextjs']
draft: false
summary: æœ¬ç¯‡ä¼šè®²è§£å¦‚ä½•å®šä¹‰ä¸€ä¸ªè·¯ç”±å¤„ç†ç¨‹åºä»¥åŠå†™è·¯ç”±å¤„ç†ç¨‹åºæ—¶å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚
---

## å‰è¨€

è·¯ç”±å¤„ç†ç¨‹åºæ˜¯æŒ‡ä½¿ç”¨ Web [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) å’Œ [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) API å¯¹äºç»™å®šçš„è·¯ç”±è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚

ç®€å•çš„æ¥è¯´ï¼Œå‰åç«¯åˆ†ç¦»æ¶æ„ä¸­ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´é€šè¿‡ API æ¥å£æ¥äº¤äº’ã€‚è¿™ä¸ªâ€œAPI æ¥å£â€åœ¨ Next.js ä¸­æœ‰ä¸ªæ›´ä¸ºæ­£å¼çš„ç§°å‘¼ï¼Œå°±æ˜¯è·¯ç”±å¤„ç†ç¨‹åºã€‚

æœ¬ç¯‡æˆ‘ä»¬ä¼šè®²è§£å¦‚ä½•å®šä¹‰ä¸€ä¸ªè·¯ç”±å¤„ç†ç¨‹åºä»¥åŠå†™è·¯ç”±å¤„ç†ç¨‹åºæ—¶å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚

## 1. å®šä¹‰è·¯ç”±å¤„ç†ç¨‹åº

å†™è·¯ç”±å¤„ç†ç¨‹åºï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ªåä¸º `route.js`çš„ç‰¹æ®Šæ–‡ä»¶ã€‚ï¼ˆæ³¨æ„æ˜¯ `route` ä¸æ˜¯ `router`ï¼‰

![image.png](http://blog.minouccc.online:9000/blog/app_router_4.1.png)

è¯¥æ–‡ä»¶å¿…é¡»åœ¨ `app`ç›®å½•ä¸‹ï¼Œå¯ä»¥åœ¨ `app` åµŒå¥—çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä½†æ˜¯è¦æ³¨æ„ `page.js`å’Œ `route.js`ä¸èƒ½åœ¨åŒä¸€å±‚çº§åŒæ—¶å­˜åœ¨ã€‚

æƒ³æƒ³ä¹Ÿèƒ½ç†è§£ï¼Œ`page.js`å’Œ `route.js`æœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹è·¯ç”±çš„å“åº”ã€‚`page.js`ä¸»è¦è´Ÿè´£æ¸²æŸ“ UIï¼Œ`route.js`ä¸»è¦è´Ÿè´£å¤„ç†è¯·æ±‚ã€‚å¦‚æœåŒæ—¶å­˜åœ¨ï¼ŒNext.js å°±ä¸çŸ¥é“ç”¨è°çš„é€»è¾‘äº†ã€‚

### 1.1. GET è¯·æ±‚

è®©æˆ‘ä»¬ä»å†™ GET è¯·æ±‚å¼€å§‹ï¼Œæ¯”å¦‚å†™ä¸€ä¸ªè·å–æ–‡ç« åˆ—è¡¨çš„æ¥å£ã€‚

æ–°å»º `app/api/posts/route.js` æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
import { NextResponse } from 'next/server'

export async function GET() {
  const res = await fetch('https://jsonplaceholder.typicode.com/posts')
  const data = await res.json()

  return NextResponse.json({ data })
}
```

æµè§ˆå™¨è®¿é—® `http://localhost:3000/api/posts` æŸ¥çœ‹æ¥å£è¿”å›çš„æ•°æ®ï¼š

![image.png](http://blog.minouccc.online:9000/blog/app_router_4.2.png)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š

1. æˆ‘ä»¬ `export` ä¸€ä¸ªåä¸º `GET` çš„ `async` å‡½æ•°æ¥å®šä¹‰ GET è¯·æ±‚å¤„ç†ï¼Œæ³¨æ„æ˜¯ export è€Œä¸æ˜¯ export default

2. æˆ‘ä»¬ä½¿ç”¨ `next/server` çš„ NextResponse å¯¹è±¡ç”¨äºè®¾ç½®å“åº”å†…å®¹ï¼Œä½†è¿™é‡Œä¸ä¸€å®šéè¦ç”¨ `NextResponse`ï¼Œç›´æ¥ä½¿ç”¨ `Response` ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š

```javascript
export async function GET() {
  const res = await fetch('https://jsonplaceholder.typicode.com/posts')
  const data = await res.json()

  return Response.json({ data })
}
```

ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ¨èä½¿ç”¨ `NextResponse`ï¼Œå› ä¸ºå®ƒæ˜¯ Next.js åŸºäº `Response` çš„å°è£…ï¼Œå®ƒå¯¹ TypeScript æ›´åŠ å‹å¥½ï¼ŒåŒæ—¶æä¾›äº†æ›´ä¸ºæ–¹ä¾¿çš„ç”¨æ³•ï¼Œæ¯”å¦‚è·å– Cookie ç­‰ã€‚

3. æˆ‘ä»¬å°†æ¥å£å†™åœ¨äº† `app/api` æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶ä¸æ˜¯å› ä¸ºæ¥å£ä¸€å®šè¦æ”¾åœ¨åä¸º `api` æ–‡ä»¶å¤¹ä¸‹ï¼ˆä¸ Pages Router ä¸åŒï¼‰ã€‚å¦‚æœä½ ä»£ç å†™åœ¨ `app/posts/route.js`ï¼Œå¯¹åº”çš„æ¥å£åœ°å€å°±æ˜¯ `/posts`ã€‚æ”¾åœ¨ `api` æ–‡ä»¶å¤¹ä¸‹åªæ˜¯ä¸ºäº†æ–¹ä¾¿åŒºåˆ†åœ°å€æ˜¯æ¥å£è¿˜æ˜¯é¡µé¢ã€‚

### 1.2. æ”¯æŒæ–¹æ³•

Next.js æ”¯æŒ `GET`ã€`POST`ã€`PUT`ã€`PATCH`ã€`DELETE`ã€`HEAD` å’Œ `OPTIONS` è¿™äº› HTTP è¯·æ±‚æ–¹æ³•ã€‚å¦‚æœä¼ å…¥äº†ä¸æ”¯æŒçš„è¯·æ±‚æ–¹æ³•ï¼ŒNext.js ä¼šè¿”å› `405 Method Not Allowed`ã€‚

```javascript
// route.js
export async function GET(request) {}

export async function HEAD(request) {}

export async function POST(request) {}

export async function PUT(request) {}

export async function DELETE(request) {}

export async function PATCH(request) {}

// å¦‚æœ `OPTIONS` æ²¡æœ‰å®šä¹‰, Next.js ä¼šè‡ªåŠ¨å®ç° `OPTIONS`
export async function OPTIONS(request) {}
```

### 1.3. ä¼ å…¥å‚æ•°

ç°åœ¨è®©æˆ‘ä»¬å…·ä½“çœ‹ä¸‹è¯·æ±‚æ–¹æ³•ã€‚æ¯ä¸ªè¯·æ±‚æ–¹æ³•çš„å¤„ç†å‡½æ•°ä¼šè¢«ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª `request`ï¼Œä¸€ä¸ª `context` ã€‚ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼š

```javascript
export async function GET(request, context) {}
```

#### request (optional)

request å¯¹è±¡æ˜¯ä¸€ä¸ª [NextRequest](xxx) çš„æ‰©å±•ã€‚ä½¿ç”¨ request ï¼Œä½ å¯ä»¥å¿«æ·è¯»å– cookies å’Œå¤„ç† URLã€‚

æˆ‘ä»¬è¿™é‡Œè®²è®²å¦‚ä½•è·å– URL å‚æ•°ï¼š

```javascript
export async function GET(request, context) {
  //  è®¿é—® /home, pathname çš„å€¼ä¸º /home
  const pathname = request.nextUrl.pathname
  // è®¿é—® /home?name=lee, searchParams çš„å€¼ä¸º { 'name': 'lee' }
  const searchParams = request.nextUrl.searchParams
}
```

å…¶ä¸­ nextUrl æ˜¯åŸºäº Web URL API çš„æ‰©å±•ï¼ˆå¦‚æœä½ æƒ³è·å–å…¶ä»–å€¼ï¼Œå‚è€ƒ [URL API](https://developer.mozilla.org/en-US/docs/Web/API/URL)ï¼‰ï¼ŒåŒæ ·æä¾›äº†ä¸€äº›æ–¹ä¾¿ä½¿ç”¨çš„æ–¹æ³•ã€‚

#### context (optional)

ç›®å‰`context` åªæœ‰ä¸€ä¸ªå€¼å°±æ˜¯ `params`ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«å½“å‰åŠ¨æ€è·¯ç”±å‚æ•°çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```javascript
// app/dashboard/[team]/route.js
export async function GET(request, { params }) {
  const team = params.team
}
```

å½“è®¿é—® `/dashboard/1` æ—¶ï¼Œparams çš„å€¼ä¸º `{ team: '1' }`ã€‚å…¶ä»–æƒ…å†µè¿˜æœ‰ï¼š

| Example                          | URL            | params                    |
| -------------------------------- | -------------- | ------------------------- |
| `app/dashboard/[team]/route.js`  | `/dashboard/1` | `{ team: '1' }`           |
| `app/shop/[tag]/[item]/route.js` | `/shop/1/2`    | `{ tag: '1', item: '2' }` |
| `app/blog/[...slug]/route.js`    | `/blog/1/2`    | `{ slug: ['1', '2'] }`    |

æ³¨æ„ç¬¬äºŒè¡Œï¼šæ­¤æ—¶ params è¿”å›äº†å½“å‰é“¾æ¥æ‰€æœ‰çš„åŠ¨æ€è·¯ç”±å‚æ•°ã€‚

### 1.4. ç¼“å­˜è¡Œä¸º

#### é»˜è®¤ç¼“å­˜

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ `Response` å¯¹è±¡ï¼ˆ`NextResponse` ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼‰çš„ GET è¯·æ±‚ä¼šè¢«ç¼“å­˜ã€‚

è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œæ–°å»º `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET() {
  console.log('GET /api/time')
  return Response.json({ data: new Date().toLocaleTimeString() })
}
```

æ³¨æ„ï¼šåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œå¹¶ä¸ä¼šè¢«ç¼“å­˜ï¼Œæ¯æ¬¡åˆ·æ–°æ—¶é—´éƒ½ä¼šæ”¹å˜ï¼š

![get-cache.gif](http://blog.minouccc.online:9000/blog/app_router_4.3.gif)

ç°åœ¨æˆ‘ä»¬éƒ¨ç½²ç”Ÿäº§ç‰ˆæœ¬ï¼Œè¿è¡Œ `npm run build && npm run start`ï¼š

![get-cache-1.gif](http://blog.minouccc.online:9000/blog/app_router_4.4.gif)

ä½ ä¼šå‘ç°ï¼Œæ— è®ºæ€ä¹ˆåˆ·æ–°ï¼Œæ—¶é—´éƒ½ä¸ä¼šæ”¹å˜ã€‚è¿™å°±æ˜¯è¢«ç¼“å­˜äº†ã€‚

å¯æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŸNext.js æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

è®©æˆ‘ä»¬çœ‹ä¸‹æ„å»ºï¼ˆnpm run buildï¼‰æ—¶çš„å‘½ä»¤è¡Œè¾“å‡ºï¼š

![æˆªå±2024-02-29 12.02.47.png](http://blog.minouccc.online:9000/blog/app_router_4.5.png)

æ ¹æ®è¾“å‡ºçš„ç»“æœï¼Œä½ ä¼šå‘ç° `/api/time` æ˜¯é™æ€çš„ï¼Œä¹Ÿå°±æ˜¯è¢«é¢„æ¸²æŸ“ä¸ºé™æ€çš„å†…å®¹ï¼Œæ¢è¨€ä¹‹ï¼Œ`/api/time` çš„è¿”å›ç»“æœå…¶å®åœ¨æ„å»ºçš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†ï¼Œè€Œä¸æ˜¯åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™æ‰ç¡®å®šã€‚

#### é€€å‡ºç¼“å­˜

ä½†å¤§å®¶ä¹Ÿä¸ç”¨æ‹…å¿ƒé»˜è®¤ç¼“å­˜å¸¦æ¥çš„å½±å“ã€‚å®é™…ä¸Šï¼Œé»˜è®¤ç¼“å­˜çš„æ¡ä»¶æ˜¯éå¸¸â€œä¸¥è‹›â€çš„ï¼Œè¿™äº›æƒ…å†µéƒ½ä¼šå¯¼è‡´é€€å‡ºç¼“å­˜ï¼š

- `GET` è¯·æ±‚ä½¿ç”¨ `Request` å¯¹è±¡

ä¿®æ”¹ `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET(request) {
  const searchParams = request.nextUrl.searchParams
  return Response.json({ data: new Date().toLocaleTimeString(), params: searchParams.toString() })
}
```

ç°åœ¨æˆ‘ä»¬éƒ¨ç½²ç”Ÿäº§ç‰ˆæœ¬ï¼Œè¿è¡Œ `npm run build && npm run start`ï¼š

![æˆªå±2024-02-29 12.37.21.png](http://blog.minouccc.online:9000/blog/app_router_4.6.png)

è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š

![get-cache-2.gif](http://blog.minouccc.online:9000/blog/app_router_4.7.gif)

æ­¤æ—¶ä¼šåŠ¨æ€æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯åœ¨è¯·æ±‚çš„æ—¶å€™å†è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ï¼Œæ‰€ä»¥æ—¶é—´ä¼šæ”¹å˜ã€‚

- æ·»åŠ å…¶ä»– HTTP æ–¹æ³•ï¼Œæ¯”å¦‚ POST

ä¿®æ”¹ `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET() {
  console.log('GET /api/time')
  return Response.json({ data: new Date().toLocaleTimeString() })
}

export async function POST() {
  console.log('POST /api/time')
  return Response.json({ data: new Date().toLocaleTimeString() })
}
```

æ­¤æ—¶ä¼šè½¬ä¸ºåŠ¨æ€æ¸²æŸ“ã€‚è¿™æ˜¯å› ä¸º POST è¯·æ±‚å¾€å¾€ç”¨äºæ”¹å˜æ•°æ®ï¼ŒGET è¯·æ±‚ç”¨äºè·å–æ•°æ®ã€‚å¦‚æœå†™äº† POST è¯·æ±‚ï¼Œè¡¨ç¤ºæ•°æ®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶ä¸é€‚åˆç¼“å­˜ã€‚

- ä½¿ç”¨åƒ cookiesã€headers è¿™æ ·çš„[åŠ¨æ€å‡½æ•°](xxx)

ä¿®æ”¹ `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET(request) {
  const token = request.cookies.get('token')
  return Response.json({ data: new Date().toLocaleTimeString() })
}
```

æ­¤æ—¶ä¼šè½¬ä¸ºåŠ¨æ€æ¸²æŸ“ã€‚è¿™æ˜¯å› ä¸º cookiesã€headers è¿™äº›æ•°æ®åªæœ‰å½“è¯·æ±‚çš„æ—¶å€™æ‰çŸ¥é“å…·ä½“çš„å€¼ã€‚

- [è·¯ç”±æ®µé…ç½®é¡¹](xxx)æ‰‹åŠ¨å£°æ˜ä¸ºåŠ¨æ€æ¨¡å¼

ä¿®æ”¹ `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export const dynamic = 'force-dynamic'

export async function GET() {
  return Response.json({ data: new Date().toLocaleTimeString() })
}
```

æ­¤æ—¶ä¼šè½¬ä¸ºåŠ¨æ€æ¸²æŸ“ã€‚è¿™æ˜¯å› ä¸ºä½ æ‰‹åŠ¨è®¾ç½®ä¸ºäº†åŠ¨æ€æ¸²æŸ“æ¨¡å¼â€¦â€¦

#### é‡æ–°éªŒè¯

é™¤äº†é€€å‡ºç¼“å­˜ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ç¼“å­˜çš„æ—¶æ•ˆï¼Œé€‚ç”¨äºä¸€äº›é‡è¦æ€§ä½ã€æ—¶æ•ˆæ€§ä½çš„é¡µé¢ã€‚

æœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯ä½¿ç”¨[è·¯ç”±æ®µé…ç½®é¡¹](xxx)ã€‚

ä¿®æ”¹ `app/api/time/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export const revalidate = 10

export async function GET() {
  return Response.json({ data: new Date().toLocaleTimeString() })
}
```

`export const revalidate = 10` è¡¨ç¤ºè®¾ç½®é‡æ–°éªŒè¯é¢‘ç‡ä¸º 10sï¼Œä½†æ˜¯è¦æ³¨æ„ï¼š

è¿™å¥ä»£ç çš„æ•ˆæœå¹¶ä¸æ˜¯è®¾ç½®æœåŠ¡å™¨æ¯ 10s ä¼šè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ `/api/time`ã€‚è€Œæ˜¯æœ€å°‘ 10s åæ‰é‡æ–°éªŒè¯ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ ç°åœ¨è®¿é—®äº† `/api/time`ï¼Œæ­¤æ—¶æ—¶é—´è®¾ä¸º 0sï¼Œ10s å†…æŒç»­è®¿é—®ï¼Œ`/api/time`è¿”å›çš„éƒ½æ˜¯ä¹‹å‰ç¼“å­˜çš„ç»“æœã€‚å½“ 10s è¿‡åï¼Œå‡è®¾ä½ ç¬¬ 12s åˆè®¿é—®äº†ä¸€æ¬¡ `/api/time`ï¼Œæ­¤æ—¶è™½ç„¶è¶…è¿‡äº† 10sï¼Œä½†ä¾ç„¶ä¼šè¿”å›ä¹‹å‰ç¼“å­˜çš„ç»“æœï¼Œä½†åŒæ—¶ä¼šè§¦å‘æœåŠ¡å™¨æ›´æ–°ç¼“å­˜ï¼Œå½“ä½ ç¬¬ 13s å†æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œå°±æ˜¯æ›´æ–°åçš„ç»“æœã€‚

ç®€å•æ¥è¯´ï¼Œè¶…è¿‡ revalidate è®¾ç½®æ—¶é—´çš„é¦–æ¬¡è®¿é—®ä¼šè§¦å‘ç¼“å­˜æ›´æ–°ï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œåç»­çš„è¿”å›å°±éƒ½æ˜¯æ–°çš„å†…å®¹ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è§¦å‘ç¼“å­˜æ›´æ–°ã€‚

è¿˜æœ‰ä¸€ç§æ˜¯ä½¿ç”¨ `next.revalidate` é€‰é¡¹ã€‚

ä¸ºäº†æ¼”ç¤ºå®ƒçš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€ä¸ªèƒ½å¤Ÿéšæœºè¿”å›æ•°æ®çš„æ¥å£ã€‚

ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹å§ï¼æ–°å»º `app/api/image/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET() {
  const res = await fetch('https://api.thecatapi.com/v1/images/search')
  const data = await res.json()
  console.log(data)
  return Response.json(data)
}
```

è®©æˆ‘ä»¬åœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰“å¼€è¿™ä¸ªé¡µé¢ï¼š

![get-cache-3.gif](http://blog.minouccc.online:9000/blog/app_router_4.8.gif)

ä½ ä¼šå‘ç°ä¸ä¹‹å‰çš„ `/api/time` ä¸åŒï¼Œ`/api/image` æ¥å£è¿”å›çš„æ•°æ®åœ¨å¼€å‘æ¨¡å¼ä¸‹åˆ·æ–°å°±å·²ç»ä¸ä¼šæ”¹å˜äº†ï¼Œå³ä½¿ console.log æ¯æ¬¡éƒ½ä¼šæ‰“å°ï¼Œè¿”å›çš„ç»“æœå´è¿˜æ˜¯ä¸€æ ·ã€‚

è¿™æ˜¯å› ä¸º Next.js æ‹“å±•äº†åŸç”Ÿçš„ fetch æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ç¼“å­˜ fetch çš„ç»“æœã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ `next.revalidate` è®¾ç½® fetch è¯·æ±‚çš„é‡æ–°éªŒè¯æ—¶é—´ï¼Œä¿®æ”¹ `app/api/image/route.js`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
export async function GET() {
  const res = await fetch('https://api.thecatapi.com/v1/images/search', {
    next: { revalidate: 5 }, //  æ¯ 5 ç§’é‡æ–°éªŒè¯
  })
  const data = await res.json()
  console.log(data)
  return Response.json(data)
}
```

åœ¨æœ¬åœ°å¤šæ¬¡åˆ·æ–°é¡µé¢ï¼Œä½ ä¼šå‘ç°æ•°æ®å‘ç”Ÿäº†æ›´æ–°ï¼š

![get-cache-4.gif](http://blog.minouccc.online:9000/blog/app_router_4.9.gif)

å¦‚æœä½ ä½¿ç”¨ç”Ÿäº§ç‰ˆæœ¬ï¼Œè™½ç„¶åœ¨æ„å»ºçš„æ—¶å€™ï¼Œ`/api/image` æ˜¾ç¤ºçš„æ˜¯é™æ€æ¸²æŸ“ï¼Œä½†æ˜¯æ•°æ®ä¼šæ›´æ–°ã€‚å…·ä½“æ›´æ–°çš„è§„å¾‹å’Œç¬¬ä¸€ç§æ–¹æ¡ˆæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚

æ³¨ï¼šNext.js çš„ç¼“å­˜æ–¹æ¡ˆæˆ‘ä»¬è¿˜ä¼šåœ¨ [ã€Šç¼“å­˜ç¯‡ | Cachingã€‹](xxx)ä¸­è¯¦ç»†ä»‹ç»ã€‚

## 2. å†™æ¥å£å¸¸è§é—®é¢˜

æ¥ä¸‹æ¥æˆ‘ä»¬è®²è®²å†™æ¥å£æ—¶å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜:

### 2.1. å¦‚ä½•è·å–ç½‘å€å‚æ•°ï¼Ÿ

```javascript
// app/api/search/route.js
// è®¿é—® /api/search?query=hello
export function GET(request) {
  const searchParams = request.nextUrl.searchParams
  const query = searchParams.get('query') // query
}
```

### 2.2. å¦‚ä½•å¤„ç† Cookieï¼Ÿ

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡ `NextRequest`å¯¹è±¡ï¼š

```javascript
// app/api/route.js
export async function GET(request) {
  const token = request.cookies.get('token')
  request.cookies.set(`token2`, 123)
}
```

å…¶ä¸­ï¼Œ`request` æ˜¯ä¸€ä¸ª `NextRequest` å¯¹è±¡ã€‚æ­£å¦‚ä¸ŠèŠ‚æ‰€è¯´ï¼Œ`NextRequest` ç›¸æ¯” `Request` æä¾›äº†æ›´ä¸ºä¾¿æ·çš„ç”¨æ³•ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

æ­¤å¤–ï¼Œè™½ç„¶æˆ‘ä»¬ä½¿ç”¨ set è®¾ç½®äº† cookieï¼Œä½†è®¾ç½®çš„æ˜¯è¯·æ±‚çš„ cookieï¼Œå¹¶æ²¡æœ‰è®¾ç½®å“åº”çš„ cookieã€‚

ç¬¬äºŒç§æ–¹æ³•æ˜¯é€šè¿‡`next/headers`åŒ…æä¾›çš„ `cookies`æ–¹æ³•ã€‚

å› ä¸º cookies å®ä¾‹åªè¯»ï¼Œå¦‚æœä½ è¦è®¾ç½® Cookieï¼Œä½ éœ€è¦è¿”å›ä¸€ä¸ªä½¿ç”¨ `Set-Cookie` header çš„ Response å®ä¾‹ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```javascript
// app/api/route.js
import { cookies } from 'next/headers'

export async function GET(request) {
  const cookieStore = cookies()
  const token = cookieStore.get('token')

  return new Response('Hello, Next.js!', {
    status: 200,
    headers: { 'Set-Cookie': `token=${token}` },
  })
}
```

### 2.3. å¦‚ä½•å¤„ç† Headers ï¼Ÿ

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡ `NextRequest`å¯¹è±¡ï¼š

```javascript
// app/api/route.js
export async function GET(request) {
  const headersList = new Headers(request.headers)
  const referer = headersList.get('referer')
}
```

ç¬¬äºŒç§æ–¹æ³•æ˜¯`next/headers`åŒ…æä¾›çš„ `headers` æ–¹æ³•ã€‚

å› ä¸º headers å®ä¾‹åªè¯»ï¼Œå¦‚æœä½ è¦è®¾ç½® headersï¼Œä½ éœ€è¦è¿”å›ä¸€ä¸ªä½¿ç”¨äº†æ–° header çš„ Response å®ä¾‹ã€‚ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
// app/api/route.js
import { headers } from 'next/headers'

export async function GET(request) {
  const headersList = headers()
  const referer = headersList.get('referer')

  return new Response('Hello, Next.js!', {
    status: 200,
    headers: { referer: referer },
  })
}
```

### 2.4. å¦‚ä½•é‡å®šå‘ï¼Ÿ

é‡å®šå‘ä½¿ç”¨ `next/navigation` æä¾›çš„ `redirect` æ–¹æ³•ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
import { redirect } from 'next/navigation'

export async function GET(request) {
  redirect('https://nextjs.org/')
}
```

### 2.5. å¦‚ä½•è·å–è¯·æ±‚ä½“å†…å®¹ï¼Ÿ

```javascript
// app/items/route.js
import { NextResponse } from 'next/server'

export async function POST(request) {
  const res = await request.json()
  return NextResponse.json({ res })
}
```

å¦‚æœè¯·æ±‚æ­£æ–‡æ˜¯ FormData ç±»å‹ï¼š

```javascript
// app/items/route.js
import { NextResponse } from 'next/server'

export async function POST(request) {
  const formData = await request.formData()
  const name = formData.get('name')
  const email = formData.get('email')
  return NextResponse.json({ name, email })
}
```

### 2.6. å¦‚ä½•è®¾ç½® CORS ï¼Ÿ

```javascript
// app/api/route.ts
export async function GET(request) {
  return new Response('Hello, Next.js!', {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    },
  })
}
```

### 2.7. å¦‚ä½•å“åº”æ—  UI å†…å®¹ï¼Ÿ

ä½ å¯ä»¥è¿”å›æ—  UI çš„å†…å®¹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè®¿é—® `/rss.xml`çš„æ—¶å€™ï¼Œä¼šè¿”å› XML ç»“æ„çš„å†…å®¹ï¼š

```javascript
// app/rss.xml/route.ts
export async function GET() {
  return new Response(`<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0">
 
<channel>
  <title>Next.js Documentation</title>
  <link>https://nextjs.org/docs</link>
  <description>The React Framework for the Web</description>
</channel>
 
</rss>`)
}
```

æ³¨ï¼š`sitemap.xml`ã€`robots.txt`ã€`app icons` å’Œ `open graph images` è¿™äº›ç‰¹æ®Šçš„æ–‡ä»¶ï¼ŒNext.js éƒ½å·²ç»æä¾›äº†å†…ç½®æ”¯æŒï¼Œè¿™äº›å†…å®¹æˆ‘ä»¬ä¼šåœ¨[ã€ŠMetadata ç¯‡ | åŸºäºæ–‡ä»¶ã€‹](xxx)è¯¦ç»†è®²åˆ°ã€‚

### 2.8. Streaming

openai çš„æ‰“å­—æ•ˆæœèƒŒåç”¨çš„å°±æ˜¯æµï¼š

```javascript
// app/api/chat/route.js
import OpenAI from 'openai'
import { OpenAIStream, StreamingTextResponse } from 'ai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export const runtime = 'edge'

export async function POST(req) {
  const { messages } = await req.json()
  const response = await openai.chat.completions.create({
    model: 'gpt-3.5-turbo',
    stream: true,
    messages,
  })

  const stream = OpenAIStream(response)

  return new StreamingTextResponse(stream)
}
```

å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨åº•å±‚çš„ Web API å®ç° Streamingï¼š

```javascript
// app/api/route.js
// https://developer.mozilla.org/docs/Web/API/ReadableStream#convert_async_iterator_to_stream
function iteratorToStream(iterator) {
  return new ReadableStream({
    async pull(controller) {
      const { value, done } = await iterator.next()

      if (done) {
        controller.close()
      } else {
        controller.enqueue(value)
      }
    },
  })
}

function sleep(time) {
  return new Promise((resolve) => {
    setTimeout(resolve, time)
  })
}

const encoder = new TextEncoder()

async function* makeIterator() {
  yield encoder.encode('<p>One</p>')
  await sleep(200)
  yield encoder.encode('<p>Two</p>')
  await sleep(200)
  yield encoder.encode('<p>Three</p>')
}

export async function GET() {
  const iterator = makeIterator()
  const stream = iteratorToStream(iterator)

  return new Response(stream)
}
```

## å°ç»“

è¿™ä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•å®šä¹‰ä¸€ä¸ªè·¯ç”±å¤„ç†ç¨‹åºï¼Œé‚£å°±æ˜¯ä½¿ç”¨æ–°çš„çº¦å®šæ–‡ä»¶ `route.js`ï¼Œåˆ‡è®° `route.js` ä¸èƒ½è·ŸåŒçº§çš„ `page.js` ä¸€èµ·ä½¿ç”¨ã€‚

åŒæ—¶æˆ‘ä»¬ä»‹ç»äº†å†™è·¯ç”±å¤„ç†ç¨‹åºä¸­å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚åœ¨å¼€å‘çš„æ—¶å€™ï¼Œå°½å¯èƒ½ä½¿ç”¨ NextRequest å’Œ NextResponseï¼Œå®ƒä»¬æ˜¯åŸºäºåŸç”Ÿ Request å’Œ Response çš„å°è£…ï¼Œæä¾›äº†å¿«æ·å¤„ç† url å’Œ cookie çš„æ–¹æ³•ã€‚

## å‚è€ƒé“¾æ¥

1.  [Routing: Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
2.  [File Conventions: route.js](https://nextjs.org/docs/app/api-reference/file-conventions/route)
3.  [Functions: NextResponse](https://nextjs.org/docs/app/api-reference/functions/next-response)
