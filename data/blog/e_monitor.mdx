---
title: ğŸ› ï¸ å‰ç«¯ç›‘æ§
date: '2024-06-21'
tags: ['å·¥ç¨‹åŒ–']
draft: false
summary: æœ¬ç¯‡æ–‡ç« å°†ä»‹ç»å‰ç«¯ç›‘æ§çš„è®¾è®¡æ€è·¯å’Œå®ç°æ–¹æ³•ã€‚
---

**å®Œæ•´çš„å‰ç«¯ç›‘æ§å¹³å°è®¾è®¡æ€è·¯**ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥ã€æ•°æ®åˆ†æå’Œå­˜å‚¨ã€æ•°æ®å±•ç¤ºã€æ•°æ®æŠ¥è­¦å’Œç›‘æ§

1: é¡µé¢æ€§èƒ½æ£€æµ‹å·¥å…·: Lighthouse

2: web-vitals: https://www.npmjs.com/package/web-vitals

> å®˜æ–¹æŒ‡æ ‡æ ‡å‡†
> | æŒ‡æ ‡ | ä½œç”¨ | æ ‡å‡† |
> | -------------------------------- | -------------- | ------------------------- |
> | `FCP(First Contentful Paint)` | `é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´` | `æ ‡å‡† â‰¤ 1s` |
> | `LCP(Largest Contentful Paint)` | `æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´` | `æ ‡å‡† â‰¤ 2s`|
> | `TTI(Time to Interactive)` | `é¡µé¢å¯äº¤äº’æ—¶é—´` | `æ ‡å‡† â‰¤ 3.2s` |

![png](http://blog.minouccc.online:9000/blog/frontend_1.2.png)
![png](http://blog.minouccc.online:9000/blog/frontend_1.3.png)
![png](http://blog.minouccc.online:9000/blog/frontend_1.4.png)
![png](http://blog.minouccc.online:9000/blog/frontend_1.5.png)
![png](http://blog.minouccc.online:9000/blog/frontend_1.6.png)

### 1. æ€§èƒ½ç›‘æ§æ”¶é›†

#### 1ï¼‰ç»Ÿè®¡FCPã€LCPç­‰æŒ‡æ ‡

**MDNæ€§èƒ½æ£€æµ‹åº¦é‡äº‹ä»¶** - [PerformanceObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver/PerformanceObserver)

> observerFCP.js

```js
export default function observerFCP() {
  const entryHandler = (list) => {
    for (const entry of list.getEntries()) {
      if (entry.name === 'first-contentful-paint') {
        observer.disconnect()
        const json = entry.toJSON()
        console.log(json)
        const reportData = {
          ...json,
          type: 'performance',
          subType: entry.name,
          pageUrl: window.location.href,
        }
        // å‘é€æ•°æ® todo;
        lazyReportBatch(reportData)
      }
    }
  }
  // ç»Ÿè®¡å’Œè®¡ç®—fcpçš„æ—¶é—´
  const observer = new PerformanceObserver(entryHandler)
  // buffered: true ç¡®ä¿è§‚å¯Ÿåˆ°æ‰€æœ‰paintäº‹ä»¶
  observer.observe({ type: 'paint', buffered: true })
}
```

##### web-vitals

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>web-vitals</title>
    <script type="module">
      import {
        onCLS,
        onINP,
        onLCP,
      } from 'https://unpkg.com/web-vitals@4/dist/web-vitals.attribution.js?module'

      onCLS(console.log)
      onINP(console.log)
      onLCP(console.log)
    </script>
  </head>

  <body>
    <div>test</div>
  </body>
</html>
```

#### 2ï¼‰ç»Ÿè®¡é™æ€èµ„æºæŒ‡æ ‡

> observerEntries.js

```js
import { lazyReportBatch } from '../report'
export default function observerEntries() {
  if (document.readyState === 'complete') {
    observerEvent()
  } else {
    const onLoad = () => {
      observerEvent()
      window.removeEventListener('load', onLoad, true)
    }
    window.addEventListener('load', onLoad, true)
  }
}
export function observerEvent() {
  const entryHandler = (list) => {
    const data = list.getEntries()
    for (let entry of data) {
      if (observer) {
        observer.disconnect()
      }
      const reportData = {
        name: entry.name, // èµ„æºçš„åå­—
        type: 'performance', // ç±»å‹
        subType: entry.entryType, //ç±»å‹
        sourceType: entry.initiatorType, // èµ„æºç±»å‹
        duration: entry.duration, // åŠ è½½æ—¶é—´
        dns: entry.domainLookupEnd - entry.domainLookupStart, // dnsè§£ææ—¶é—´
        tcp: entry.connectEnd - entry.connectStart, // tcpè¿æ¥æ—¶é—´
        redirect: entry.redirectEnd - entry.redirectStart, // é‡å®šå‘æ—¶é—´
        ttfb: entry.responseStart, // é¦–å­—èŠ‚æ—¶é—´
        protocol: entry.nextHopProtocol, // è¯·æ±‚åè®®
        responseBodySize: entry.encodedBodySize, // å“åº”å†…å®¹å¤§å°
        responseHeaderSize: entry.transferSize - entry.encodedBodySize, // å“åº”å¤´éƒ¨å¤§å°
        transferSize: entry.transferSize, // è¯·æ±‚å†…å®¹å¤§å°
        resourceSize: entry.decodedBodySize, // èµ„æºè§£å‹åçš„å¤§å°
        startTime: performance.now(),
      }
      lazyReportBatch(reportData)
      // console.log(entry);
    }
  }

  let observer = new PerformanceObserver(entryHandler)
  observer.observe({ type: ['resource'], buffered: true })
}
```

#### 3ï¼‰é¡µé¢ load æ—¶é—´ç»Ÿè®¡

> observerLoad.js

```js
export default function observerLoad() {
  window.addEventListener('pageShow', function (event) {
    requestAnimationFrame(() => {
      ;['load'].forEach((type) => {
        const reportData = {
          type: 'performance',
          subType: type,
          pageUrl: window.location.href,
          startTime: performance.now() - event.timeStamp,
        }
        // å‘é€æ•°æ®
        lazyReportBatch(reportData)
      })
    }, true)
  })
}
```

#### 4ï¼‰ç»Ÿè®¡ ajax çš„è¯·æ±‚æ—¶é—´ - xhr

`loadend` äº‹ä»¶æ€»æ˜¯åœ¨ä¸€ä¸ªèµ„æºçš„åŠ è½½è¿›åº¦åœæ­¢ä¹‹åè¢«è§¦å‘ã€‚

> xhr.js

```js
export const originalProto = XMLHttpRequest.prototype
export const originalSend = originalProto.send
export const originalOpen = originalProto.open

function overwriteOpenAndSend() {
  originalProto.open = function newOpen(...args) {
    this.url = args[1]
    this.method = args[0]
    originalOpen.apply(this, args)
  }
  originalProto.send = function newSend(...args) {
    this.startTime = Date.now()
    const onLoaded = () => {
      this.endTime = Date.now()
      this.duration = this.endTime - this.startTime
      const { url, method, startTime, endTime, duration, status } = this
      const reportData = {
        status,
        duration,
        startTime,
        endTime,
        url,
        method: method.toUpperCase(),
        type: 'performance',
        success: status >= 200 && status < 300,
        subType: 'xhr',
      }
      // todo å‘é€æ•°æ®
      lazyReportBatch(reportData)
      this.removeEventListener('loadend', onLoaded, true)
    }
    this.addEventListener('loadend', onLoaded, true)
    originalSend.apply(this, args)
  }
}
export default function xhr() {
  overwriteOpenAndSend()
}
```

#### 5ï¼‰ç»Ÿè®¡ ajax çš„è¯·æ±‚æ—¶é—´ - fetch

> fetch.js

```js
import { lazyReportBatch } from '../report'
const originalFetch = window.fetch
function overwriteFetch() {
  window.fetch = function newFetch(url, config) {
    const startTime = Date.now()
    const reportData = {
      type: 'performance',
      subType: 'fetch',
      url,
      startTime,
      method: config.method,
    }
    return originalFetch(url, config)
      .then((res) => {
        const endTime = Date.now()
        reportData.endTime = endTime
        reportData.duration = endTime - startTime
        const data = res.clone()
        reportData.status = data.status
        reportData.success = data.ok
        // todo ä¸ŠæŠ¥æ•°æ®
        lazyReportBatch(reportData)
        return res
      })
      .catch((err) => {
        const endTime = Date.now()
        reportData.endTime = endTime
        reportData.duration = endTime - startTime
        reportData.status = 0
        reportData.success = false
        // todo ä¸ŠæŠ¥æ•°æ®
        lazyReportBatch(reportData)
      })
  }
}
export default function fetch() {
  overwriteFetch()
}
```

### 2. é”™è¯¯ç›‘æ§æ”¶é›†

åŒ…æ‹¬ä»¥ä¸‹ï¼š

- js ä»£ç è¿è¡Œé”™è¯¯ã€è¯­æ³•é”™è¯¯ç­‰ã€‚
- å¼‚æ­¥é”™è¯¯ç­‰
- é™æ€èµ„æºåŠ è½½é”™è¯¯
- æ¥å£è¯·æ±‚æŠ¥é”™

#### js åŸç”Ÿé”™è¯¯

- è¯­æ³•é”™è¯¯

  ã€åŸå› ã€‘ï¼šè¿™ç§é”™è¯¯é€šå¸¸ç”±äºä»£ç ä¹¦å†™ä¸è§„èŒƒæˆ–è€…è¯­æ³•é”™è¯¯å¼•èµ·ï¼Œä»£ç ç¼–è¯‘å°±å¯ä»¥è¢«å‘ç°ã€‚

- è¿è¡Œæ—¶é”™è¯¯

  ã€åŸå› ã€‘ï¼šè¿™ç§é”™è¯¯é€šå¸¸ç”±äºä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ï¼Œé€šå¸¸éœ€è¦åœ¨ä»£ç å®é™…è¿è¡Œæ—¶æ‰èƒ½è¢«å‘ç°ã€‚

- é€»è¾‘é”™è¯¯

  ã€åŸå› ã€‘ï¼šè¿™ç§é”™è¯¯é€šå¸¸ç”±äºä»£ç é€»è¾‘ä¸æ­£ç¡®ï¼Œè¿™ç§é”™è¯¯é€šå¸¸æ¯”è¾ƒéš¾ä»¥å‘ç°å’Œè§£å†³ã€‚

error äº‹ä»¶æ˜¯ç”¨æ¥ç›‘å¬ DOM æ“ä½œé”™è¯¯ DOMException å’Œ js é”™è¯¯å‘Šè­¦çš„ï¼Œå…·ä½“æ¥è¯´ï¼Œjs é”™è¯¯åˆ†ä¸ºä¸‹é¢ 8 ç±»:

- InternalError: å†…éƒ¨é”™è¯¯ï¼Œæ¯”å¦‚é€’å½’çˆ†æ ˆã€‚
- RangeError: èŒƒå›´é”™è¯¯ï¼Œæ¯”å¦‚`new Array(-1)`ã€‚ã€è¿è¡Œé”™è¯¯ã€‘--æ•°ç»„èŒƒå›´é”™è¯¯ã€‚
- EvalError: ä½¿ç”¨ eval() æ—¶é”™è¯¯ã€‚ã€è¿è¡Œé”™è¯¯ã€‘
- ReferenceError: å¼•ç”¨é”™è¯¯ï¼Œæ¯”å¦‚ä½¿ç”¨æœªå®šä¹‰å˜é‡ã€‚ã€è¿è¡Œé”™è¯¯ã€‘--å˜é‡å¼•ç”¨é”™è¯¯ã€‚
- SyntaxError: è¯­æ³•é”™è¯¯ï¼Œæ¯”å¦‚`var a = `ã€‚ã€è¯­æ³•é”™è¯¯ã€‘ã€è¿è¡Œé”™è¯¯ã€‘
- TypeError: ç±»å‹é”™è¯¯ï¼Œæ¯”å¦‚`[1,2].split('.')`ã€‚ã€è¿è¡Œé”™è¯¯ã€‘--æ•°æ®ç±»å‹é”™è¯¯ã€‚
- URLErrorï¼šç»™ encodeURL æˆ– decodeURL() ä¼ é€’çš„å‚æ•°æ— æ•ˆï¼Œæ¯”å¦‚decodeURL('%2')ã€‚
- Error: ä¸Šé¢7ç§é”™è¯¯çš„åŸºç±»ï¼Œé€šå¸¸æ˜¯å¼€å‘è€…æŠ›å‡ºã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä»£ç è¿è¡Œæ—¶å‘ç”Ÿçš„ä¸Šè¿°8ç±»é”™è¯¯ï¼Œéƒ½å¯ä»¥è¢«æ£€æµ‹åˆ°ã€‚

#### é”™è¯¯æ•è·æ–¹å¼

1ï¼‰try-catch è¯­å¥

```js
try {
  // å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
} catch (err) {
  // å¤„ç†å¼‚å¸¸çš„ä»£ç 
}
```

> try-catch è¯­å¥å¯ä»¥ç”¨æ¥æ•è· js ä»£ç ä¸­çš„è¯­æ³•é”™è¯¯å’Œè¿è¡Œæ—¶é”™è¯¯ã€‚å½“ä»£ç å—ä¸­çš„è¯­å¥æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œç¨‹åºä¼šè·³è½¬åˆ° catch è¯­å¥å—ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚
> æ³¨æ„: try-catch è¯­å¥é€‚ç”¨äºåŒæ­¥ä»£ç çš„é”™è¯¯æ•è·ï¼Œå¦‚æœä»£ç å—ä¸­å­˜åœ¨**å¼‚æ­¥ä»£ç **ï¼Œtry-catch è¯­å¥æ— æ³•æ•è·å¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯ã€‚

2ï¼‰window.onerror

æ•æ‰å…¨å±€ JS å¼‚å¸¸ï¼ŒåŒ…æ‹¬åŒæ­¥å’Œå¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯ã€‚

```js
window.onerror = function (message, source, lineno, colno, error) {
  // å¤„ç†é”™è¯¯çš„ä»£ç 
}
```

> window.onerror æ˜¯ä¸€ä¸ªå…¨å±€çš„é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥æ•è·æœªè¢« try-catch æ•è·çš„è¿è¡Œæ—¶é”™è¯¯ã€‚å½“ JavaScript ä»£ç æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ window.onerror äº‹ä»¶ï¼Œå¹¶ä¼ é€’ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ã€‚

3ï¼‰window.addEventListener("error")

æ•æ‰é™æ€èµ„æºåŠ è½½é”™è¯¯ã€‚

- å¯ä»¥æ•æ‰å›¾ç‰‡ã€scriptã€css ç­‰åŠ è½½çš„é”™è¯¯ã€‚
- ä¸å¯ä»¥æ•æ‰ï¼šnew Image() é”™è¯¯å’Œ fetch é”™è¯¯ã€‚

```js
window.addEventListener('error', function (event) {
  // å¤„ç†é”™è¯¯
})
```

> window.addEventListener('error', ...) æä¾›äº†ä¸€ç§ç›‘è§† window å¯¹è±¡ä¸Šçš„ error äº‹ä»¶çš„æ–¹æ³•ã€‚ä¸ window.onerror ä¸åŒï¼Œerror äº‹ä»¶çš„ç›‘å¬å™¨å¯ä»¥åœ¨é¡µé¢ä¸­çš„ä»»ä½•å…ƒç´ ä¸Šæ³¨å†Œï¼Œä»¥æ•æ‰ç‰¹å®šå…ƒç´ äº§ç”Ÿçš„é”™è¯¯ã€‚

4ï¼‰unhandledrjection

Promise å†…éƒ¨æŠ›å‡ºçš„é”™è¯¯æ˜¯æ— æ³•è¢« error æ•è·åˆ°çš„ï¼Œè¿™æ—¶éœ€è¦ç”¨ unhandledrjection äº‹ä»¶ã€‚

```js
window.addEventListener('unhandledrejection', (event) => {
  console.warn(`UNHANDLED PROMISE REJECTION: ${event.reason}`)
})
```

#### ä¾‹å­

1ï¼‰try-catch

```js
    <script>
        setTimeout(() => {
            try {
                console.log('1->begin');
                error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
                console.log('1->end');
            } catch (e) {
                console.log('catch---', e);
            }
        }, 1000);
    </script>
```

```js
catch--- ReferenceError: error is not defined
    at test.html:27:17
```

2ï¼‰try-catch

```js
    <script>
        function fn() {
            console.log('1->begin');
            error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
            console.log('1->end');
        }

        setTimeout(() => {
            try {
                fn(); // è°ƒç”¨ fn å‡½æ•°
            } catch (e) {
                console.table('catch', e); // æ•è·é”™è¯¯å¹¶æ‰“å°
            }
        }, 1000);
    </script>
```

```js
catch ReferenceError: error is not defined
    at fn (test.html:26:13)
    at test.html:32:17
```

3ï¼‰try-catch

```js
    <script>
        function fn() {
            console.log('1->begin');
            error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
            console.log('1->end');
        }

        try {
            setTimeout(() => {
                fn(); // è°ƒç”¨ fn å‡½æ•°
            });
        } catch (e) {
            console.log('catch', e); // å¤„ç†å¼‚æ­¥çš„æ—¶å€™é”™è¯¯æ²¡æœ‰æ•è·
        }
    </script>
```

```js
// æ­¤æ—¶é”™è¯¯æ˜¯æµè§ˆå™¨æŠ›å‡ºçš„ æ²¡æœ‰è¢« catch æ•è·
test.html:26 Uncaught ReferenceError: error is not defined
    at fn (test.html:26:13)
    at test.html:32:17
```

4ï¼‰window.onerror

```js
<script>
        function fn() {
            console.log('1->begin');
            error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
            console.log('1->end'); // è¿™è¡Œä¸ä¼šè¢«æ‰§è¡Œ
        }

        window.onerror = (...args) => {
            console.log('onerror:', args); // æ•è·é”™è¯¯å¹¶æ‰“å°
        };

        setTimeout(() => {
            fn(); // è°ƒç”¨ fn å‡½æ•°
        }, 1000);
    </script>
```

![png](http://blog.minouccc.online:9000/blog/frontend_1.7.png)

5ï¼‰window.addEventListener('error', ...)

```js
<body>
    <img src="xxx.jpg" />
</body>
  <script>
        window.addEventListener('error', (args) => {
            console.log('error event:', args);
            return true; // é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸º
        }, true);
    </script>
```

![png](http://blog.minouccc.online:9000/blog/frontend_1.8.png)

6ï¼‰promise.catch

```js
   <script>
        new Promise((resolve, reject) => {
            error(); // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
        }).catch(err => {
            console.log('promise catch:', err); // æ•è·å¹¶æ‰“å°é”™è¯¯
        });
    </script>
```

```js
promise catch: ReferenceError: error is not defined
    at test.html:10:13
    at new Promise (<anonymous>)
    at test.html:9:9
```

ä½†é’ˆå¯¹æ—§ä»£ç å…¨éƒ¨æ·»åŠ .catchä¸æ–¹ä¾¿ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼:

```js
    <script>
        new Promise((resolve, reject) => {
            error(); // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
        })

        window.addEventListener('unhandledrejection', (e) => {
            console.log('unhandledrejection', e);
            // throw e.reason;
        });
    </script>
```

![png](http://blog.minouccc.online:9000/blog/frontend_1.9.png)

7ï¼‰async/await

```js
    <script>
        const asyncFunc = () => new Promise((resolve, reject) => {
            error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
        });

        setTimeout(async () => {
            try {
                await asyncFunc(); // ç­‰å¾… asyncFunc çš„æ‰§è¡Œ
            } catch (e) {
                console.log('catch:', e); // æ•è·å¹¶æ‰“å°é”™è¯¯
            }
        }, 1000);
    </script>
```

```js
catch: ReferenceError: error is not defined
    at test.html:10:13
    at new Promise (<anonymous>)
    at asyncFunc (test.html:9:33)
    at test.html:15:23
```

ç­‰åŒäº:

```js
window.addEventListener('unhandledrejection', (e) => {
  console.log('unhandledrejection', e)
  // throw e.reason;
})

const asyncFunc = () =>
  new Promise((resolve) => {
    error // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
  })

setTimeout(async () => {
  await asyncFunc() // ç­‰å¾… asyncFunc çš„æ‰§è¡Œ
}, 1000)
```

8ï¼‰ç»“åˆ

ä¸€èˆ¬ä½¿ç”¨`unhandledrejection` throw é”™è¯¯ï¼Œå†ç”±`window.addEventListener('error', ...)`æ•è·

```js
    <script>
        window.addEventListener('error', (args) => {
            console.log('error event:', args);
            return true; // é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸º
        }, true);

        window.addEventListener("unhandledrejection", (e) => {
            throw e.reason;
        });

        const asyncFunc = () => new Promise((resolve) => {
            error; // è¿™é‡Œä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯
        });

        setTimeout(async () => {
            await asyncFunc(); // ç­‰å¾… asyncFunc çš„æ‰§è¡Œ
        }, 1000);
    </script>
```

![png](http://blog.minouccc.online:9000/blog/frontend_1.10.png)

9ï¼‰æœ€ä½³å®è·µ

> error.js

```js
export default function error() {
  // æ•è·èµ„æºåŠ è½½å¤±è´¥çš„é”™è¯¯ï¼š js css  img
  window.addEventListener(
    'error',
    function (e) {
      const target = e.target
      if (target.src || target.href) {
        const url = target.src || target.href
        const reportData = {
          type: 'error',
          subType: 'resource',
          url,
          html: target.outerHTML,
          pageUrl: window.location.href,
          pahts: e.path,
        }
        // todo å‘é€é”™è¯¯ä¿¡æ¯
        lazyReportBatch(reportData)
      }
    },
    true
  )
  // æ•è·jsé”™è¯¯
  window.onerror = function (msg, url, lineNo, columnNo, error) {
    const reportData = {
      type: 'error',
      subType: 'js',
      msg,
      url,
      lineNo,
      columnNo,
      stack: error.stack,
      pageUrl: window.location.href,
      startTime: performance.now(),
    }
    // todo å‘é€é”™è¯¯ä¿¡æ¯
    lazyReportBatch(reportData)
  }
  // æ•è·promiseé”™è¯¯  asyn await
  window.addEventListener(
    'unhandledrejection',
    function (e) {
      const reportData = {
        type: 'error',
        subType: 'promise',
        reason: e.reason?.stack,
        pageUrl: window.location.href,
        startTime: e.timeStamp,
      }
      // todo å‘é€é”™è¯¯ä¿¡æ¯
      lazyReportBatch(reportData)
    },
    true
  )
}
```

10ï¼‰Vue / React æ¡†æ¶é”™è¯¯æ”¶é›†

- Vue ä½¿ç”¨ [app.config.errorhandler](https://cn.vuejs.org/api/application.html#app-config-errorhandler)
- React ä½¿ç”¨ [ErrorBoundary](https://zh-hans.react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)

```js
import performance from './performance/index'
import error from './error/index'
import behavior from './behavior/index'
import { setConfig } from './config'
import { lazyReportBatch } from './report'
window.__webEyeSDK__ = {
  version: '0.0.1',
}

// é’ˆå¯¹Vueé¡¹ç›®çš„é”™è¯¯æ•è·
export function install(Vue, options) {
  if (__webEyeSDK__.vue) return
  __webEyeSDK__.vue = true
  setConfig(options)
  const handler = Vue.config.errorHandler
  // vueé¡¹ç›®ä¸­ é€šè¿‡ Vue.config.errorHandler æ•è·é”™è¯¯
  Vue.config.errorHandler = function (err, vm, info) {
    // todo: ä¸ŠæŠ¥å…·ä½“çš„é”™è¯¯ä¿¡æ¯
    const reportData = {
      info,
      error: err.stack,
      subType: 'vue',
      type: 'error',
      startTime: window.performance.now(),
      pageURL: window.location.href,
    }
    lazyReportBatch(reportData)
    if (handler) {
      handler.call(this, err, vm, info)
    }
  }
}
// é’ˆå¯¹Reacté¡¹ç›®çš„é”™è¯¯æ•è·
export function errorBoundary(err, info) {
  if (__webEyeSDK__.react) return
  __webEyeSDK__.react = true
  // todo: ä¸ŠæŠ¥å…·ä½“çš„é”™è¯¯ä¿¡æ¯
  const reportData = {
    error: err?.stack,
    info,
    subType: 'react',
    type: 'error',
    startTime: window.performance.now(),
    pageURL: window.location.href,
  }
  lazyReportBatch(reportData)
}
export function init(options) {
  setConfig(options)
  // performance();
  // error();
  // behavior();
}

export default {
  install,
  errorBoundary,
  performance,
  error,
  behavior,
  init,
}

// webEyeSDK.init({
//     appId: '10000',
//     batchSize: 50,

// })
```

### 3. æ•°æ®ä¸ŠæŠ¥

| æ–¹æ³•                  | æè¿°     |
| --------------------- | -------- |
| `xhr`                 | ä¸ŠæŠ¥æ–¹å¼ |
| `image gif`           | ä¸ŠæŠ¥æ–¹å¼ |
| `sendBeacon`          | ä¸ŠæŠ¥æ–¹å¼ |
| `requestIdleCallback` | ä¸ŠæŠ¥æ—¶æœº |
| `setTimeout`          | ä¸ŠæŠ¥æ—¶æœº |
| `beforeUnload`        | ä¸ŠæŠ¥æ—¶æœº |
| `æ‰¹é‡ä¸ŠæŠ¥`            | ä¸ŠæŠ¥æ—¶æœº |

> report.js

```js
import config from './config'
import { generateUniqueId } from './utils'
import { addCache, getCache, clearCache } from './cache'
export const originalProto = XMLHttpRequest.prototype
export const originalOpen = XMLHttpRequest.prototype.open
export const originalSend = XMLHttpRequest.prototype.send
export function isSupportSendBeacon() {
  return 'sendBeacon' in navigator
}
export function report(data) {
  if (!config.url) {
    console.error('è¯·è®¾ç½®ä¸Šä¼  url åœ°å€')
  }
  const reportData = JSON.stringify({
    id: generateUniqueId(),
    data,
  })
  // ä¸ŠæŠ¥æ•°æ®ï¼Œä½¿ç”¨å›¾ç‰‡çš„æ–¹å¼
  if (config.isImageUpload) {
    imgRequest(reportData)
  } else {
    // ä¼˜å…ˆä½¿ç”¨ sendBeacon
    if (window.navigator.sendBeacon) {
      return beaconRequest(reportData)
    } else {
      xhrRequest(reportData)
    }
  }
}
// æ‰¹é‡ä¸ŠæŠ¥æ•°æ®
export function lazyReportBatch(data) {
  addCache(data)
  const dataCache = getCache()
  console.error('dataCache', dataCache)
  if (dataCache.length && dataCache.length > config.batchSize) {
    report(dataCache)
    clearCache()
  }
  //
}
// å›¾ç‰‡å‘é€æ•°æ®
export function imgRequest(data) {
  const img = new Image()
  // http://127.0.0.1:8080/api?data=encodeURIComponent(data)
  img.src = `${config.url}?data=${encodeURIComponent(JSON.stringify(data))}`
}
// æ™®é€šajaxå‘é€è¯·æ±‚æ•°æ®
export function xhrRequest(data) {
  if (window.requestIdleCallback) {
    window.requestIdleCallback(
      () => {
        const xhr = new XMLHttpRequest()
        originalOpen.call(xhr, 'post', config.url)
        originalSend.call(xhr, JSON.stringify(data))
      },
      { timeout: 3000 }
    )
  } else {
    setTimeout(() => {
      const xhr = new XMLHttpRequest()
      originalOpen.call(xhr, 'post', url)
      originalSend.call(xhr, JSON.stringify(data))
    })
  }
}

export function beaconRequest(data) {
  if (window.requestIdleCallback) {
    window.requestIdleCallback(
      () => {
        window.navigator.sendBeacon(config.url, data)
      },
      { timeout: 3000 }
    )
  } else {
    setTimeout(() => {
      window.navigator.sendBeacon(config.url, data)
    })
  }
}
```

> cache.js

```js
import { deepCopy } from './utils.js'

const cache = []
export function getCache() {
  return deepCopy(cache)
}
export function addCache(data) {
  cache.push(data)
}
export function clearCache() {
  cache.length = 0
}
```

> config.js

```js
const config = {
  url: 'http://127.0.0.1:8080/api',
  projectName: 'eyesdk',
  appId: '123456',
  userId: '123456',
  isImageUpload: false,
  batchSize: 5,
}
export function setConfig(options) {
  for (const key in config) {
    if (options[key]) {
      config[key] = options[key]
    }
  }
}
export default config
```

### 4. ç”¨æˆ·è¡Œä¸º

1ï¼‰pv ç»Ÿè®¡

> pv.js

```js
import { lazyReportBatch } from '../report'
import { generateUniqueId } from '../utils'
export default function pv() {
  const reportData = {
    type: 'behavior',
    subType: 'pv',
    startTime: performance.now(),
    pageUrl: window.location.href,
    referror: document.referrer,
    uuid: generateUniqueId(),
  }
  lazyReportBatch(reportData)
}
```

> pageChange.js

```js
import { lazyReportBatch } from '../report'
import { generateUniqueId } from '../utils'
export default function pageChange() {
  // hash histroy
  let oldUrl = ''
  window.addEventListener(
    'hashchange',
    function (event) {
      console.error('hashchange', event)
      const newUrl = event.newURL
      const reportData = {
        form: oldUrl,
        to: newUrl,
        type: 'behavior',
        subType: 'hashchange',
        startTime: performance.now(),
        uuid: generateUniqueId(),
      }
      lazyReportBatch(reportData)
      oldUrl = newUrl
    },
    true
  )

  let from = ''
  window.addEventListener(
    'popstate',
    function (event) {
      console.error('popstate', event)
      const to = window.location.href
      const reportData = {
        form: from,
        to: to,
        type: 'behavior',
        subType: 'popstate',
        startTime: performance.now(),
        uuid: generateUniqueId(),
      }
      lazyReportBatch(reportData)
      from = to
    },
    true
  )
}
```

2ï¼‰ç‚¹å‡»è¡Œä¸º

> onClick.js

```js
import { lazyReportBatch } from '../report'
export default function click() {
  ;['mousedown', 'touchstart'].forEach((eventType) => {
    window.addEventListener(eventType, (e) => {
      const target = e.target
      if (target.tagName) {
        const reportData = {
          // scrollTop: document.documentElement.scrollTop,
          type: 'behavior',
          subType: 'click',
          target: target.tagName,
          startTime: e.timeStamp,
          innerHtml: target.innerHTML,
          outerHtml: target.outerHTML,
          with: target.offsetWidth,
          height: target.offsetHeight,
          eventType,
          path: e.path,
        }
        lazyReportBatch(reportData)
      }
    })
  })
}
```
